name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
    CARGO_TERM_COLOR: always
    RUSTFLAGS: --deny warnings -C debuginfo=line-tables-only
    RUSTDOCFLAGS: --deny warnings

jobs:
    check:
        name: Check
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
            - uses: Swatinem/rust-cache@v2
              with:
                save-if: ${{ github.ref == 'refs/heads/main' }}
                shared-key: lints
            - name: Run cargo check
              run: cargo check --locked --all-targets

    docs:
        name: Check Documentation
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
            - uses: Swatinem/rust-cache@v2
              with:
                save-if: ${{ github.ref == 'refs/heads/main' }}
                shared-key: lints
            - name: Run cargo doc
              run: cargo doc --locked --workspace --no-deps --document-private-items --keep-going

    test:
        name: Test Suite
        strategy:
            matrix:
                os: [windows-latest, macos-latest, ubuntu-latest]
        runs-on: ${{ matrix.os }}
        timeout-minutes: 60
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
            - uses: Swatinem/rust-cache@v2
              with:
                save-if: ${{ github.ref == 'refs/heads/main' }}
                shared-key: test-${{ matrix.os }}
            - uses: cargo-bins/cargo-binstall@main
            - name: Install nextest
              run: cargo binstall cargo-nextest --secure --force
            - name: Run cargo test
              run: cargo nextest run --locked --no-default-features --lib --bins --examples --no-fail-fast --features enhanced-determinism,parallel,collider-from-mesh,serialize,debug-plugin,avian2d/2d,avian3d/3d,avian2d/f64,avian3d/f64,default-collider,parry-f64,bevy_scene,bevy_picking,diagnostic_ui
            - name: Run doc tests
              run: cargo test --locked --doc --no-default-features --features enhanced-determinism,parallel,collider-from-mesh,serialize,debug-plugin,avian2d/2d,avian3d/3d,avian2d/f64,avian3d/f64,default-collider,parry-f64,bevy_scene,bevy_picking,diagnostic_ui

    lints:
        name: Lints
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
            - uses: Swatinem/rust-cache@v2
              with:
                save-if: ${{ github.ref == 'refs/heads/main' }}
                shared-key: lints
            - name: Run cargo fmt
              run: cargo fmt --all -- --check
            - name: Run cargo clippy
              run: cargo clippy --locked --all-targets
